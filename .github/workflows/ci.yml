name: CI
on:
  # # will update to main when is ready
  pull_request:
    branches: [opps]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  STAGING_URL: https://e2e.chrry.ai
  STAGING_API_URL: https://e2e.chrry.dev
  TURBO_TOKEN: ${{ secrets.VPS_TURBO_TOKEN }}
  TURBO_TEAM: vex
  TURBO_REMOTE_CACHE_SIGNATURE_KEY: ${{ secrets.TURBO_REMOTE_CACHE_SIGNATURE_KEY }}
  TURBO_API: ${{ secrets.TURBO_API }}
  TURBO_VERBOSE: 1
  NODE_OPTIONS: --max-old-space-size=8192
  TESTING_ENV: e2e
  VITE_TESTING_ENV: e2e
  VITE_CI: true
  CI: true
  BUILD_ID: ${{ github.sha }}

  # Node environment
  NODE_ENV: test
  VITE_NODE_ENV: test

  # Database
  DB_URL: ${{ secrets.DB_URL }}

  # Auth
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
  NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
  AUTH_TRUST_HOST: ${{ secrets.AUTH_TRUST_HOST }}

  # Test users
  VEX_TEST_EMAIL: ${{ secrets.VEX_TEST_EMAIL }}
  VEX_TEST_NAME: ${{ secrets.VEX_TEST_NAME }}
  VEX_TEST_PASSWORD: ${{ secrets.VEX_TEST_PASSWORD }}
  VEX_TEST_EMAIL_2: ${{ secrets.VEX_TEST_EMAIL_2 }}
  VEX_TEST_NAME_2: ${{ secrets.VEX_TEST_NAME_2 }}
  VEX_TEST_PASSWORD_2: ${{ secrets.VEX_TEST_PASSWORD_2 }}
  VEX_TEST_EMAIL_3: ${{ secrets.VEX_TEST_EMAIL_3 }}
  VEX_TEST_NAME_3: ${{ secrets.VEX_TEST_NAME_3 }}
  VEX_TEST_PASSWORD_3: ${{ secrets.VEX_TEST_PASSWORD_3 }}
  VEX_TEST_EMAIL_4: ${{ secrets.VEX_TEST_EMAIL_4 }}
  VEX_TEST_NAME_4: ${{ secrets.VEX_TEST_NAME_4 }}
  VEX_TEST_PASSWORD_4: ${{ secrets.VEX_TEST_PASSWORD_4 }}
  TEST_MEMBER_FINGERPRINTS: ${{ secrets.TEST_MEMBER_FINGERPRINTS }}
  TEST_MEMBER_EMAILS: ${{ secrets.TEST_MEMBER_EMAILS }}
  TEST_GUEST_FINGERPRINTS: ${{ secrets.TEST_GUEST_FINGERPRINTS }}

  # Push notifications
  VITE_VAPID_PUBLIC_KEY: ${{ secrets.VITE_VAPID_PUBLIC_KEY }}
  VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}

  # Stripe
  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
  STRIPE_PRICE_PLUS_ID: ${{ secrets.STRIPE_PRICE_PLUS_ID }}
  STRIPE_PRICE_CREDITS_ID: ${{ secrets.STRIPE_PRICE_CREDITS_ID }}
  STRIPE_PRICE_PRO_ID: ${{ secrets.STRIPE_PRICE_PRO_ID }}
  VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}

  # OAuth
  APPLE_CLIENT_ID: ${{ secrets.APPLE_CLIENT_ID }}
  APPLE_CLIENT_SECRET: ${{ secrets.APPLE_CLIENT_SECRET }}
  GOOGLE_WEB_CLIENT_ID: ${{ secrets.GOOGLE_WEB_CLIENT_ID }}
  GOOGLE_WEB_CLIENT_SECRET: ${{ secrets.GOOGLE_WEB_CLIENT_SECRET }}

  # URLs
  CHRRY_URL: ${{ secrets.CHRRY_URL }}
  VITE_API_URL: ${{ secrets.VITE_API_URL }}
  VITE_SITE_MODE: ${{ secrets.VITE_SITE_MODE }}
  VITE_WS_URL: ${{ secrets.VITE_WS_URL }}
  WS_SERVER_URL: ${{ secrets.WS_SERVER_URL }}

  # Redis
  REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
  REDIS_URL: ${{ secrets.REDIS_URL }}

jobs:
  # Safety check: prevent external PRs from triggering deployments
  cancel-deployments:
    runs-on: ubuntu-latest
    steps:
      - name: Cancel in-progress API deployment
        env:
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
        continue-on-error: true
        run: |
          echo "üõë Canceling any in-progress API deployment..."
          curl -X POST "https://coolify.askvex.com/api/v1/applications/z84cko4g4kwss0gockcgkogw/cancel" \
            -H "Authorization: Bearer $COOLIFY_TOKEN" || echo "No deployment to cancel"

      - name: Cancel in-progress Web deployment
        env:
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
        continue-on-error: true
        run: |
          echo "üõë Canceling any in-progress Web deployment..."
          curl -X POST "https://coolify.askvex.com/api/v1/applications/xcgo4kw884kkow40wk040sco/cancel" \
            -H "Authorization: Bearer $COOLIFY_TOKEN" || echo "No deployment to cancel"

  build:
    runs-on: ubuntu-latest
    needs: cancel-deployments
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/pnpm-lock.yaml', 'turbo.json') }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm turbo lint

      - name: Unit Tests
        run: pnpm turbo test

      - name: Type check
        run: pnpm turbo check-types

      - name: Build packages
        run: pnpm run build

  # Deploy both API and Web sequentially
  deploy:
    runs-on: ubuntu-latest
    needs: [build, cancel-deployments]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Deploy API to Coolify
        env:
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
        run: |
          echo "üì¶ Deploying API app (e2e.chrry.dev)..."
          curl -X GET "https://coolify.askvex.com/api/v1/deploy?uuid=z84cko4g4kwss0gockcgkogw&force=false" \
            -H "Authorization: Bearer $COOLIFY_TOKEN"

      - name: Wait for API deployment
        run: |
          echo "‚è≥ Waiting for API to finish deploying..."
          MAX_ATTEMPTS=150
          ATTEMPT=0

          # Read expected version from package.json
          EXPECTED_VERSION=$(jq -r '.version' package.json)

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            echo "üîç Checking $STAGING_API_URL/api/health..."
            if curl -f --compressed $STAGING_API_URL/api/health > /dev/null 2>&1; then
              API_VERSION=$(curl -s --compressed $STAGING_API_URL/api/health | jq -r '.version' 2>/dev/null || echo "unknown")
              echo "üì¶ API version: $API_VERSION (expected: $EXPECTED_VERSION)"

              if [ "$API_VERSION" = "$EXPECTED_VERSION" ]; then
                echo "‚úÖ API deployment complete!"
                exit 0
              fi
            else
              echo "‚ùå Health check failed (curl exit code: $?)"
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "‚è≥ Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            sleep 10
          done

          echo "‚ùå API deployment timed out"
          exit 1

      - name: Deploy Web to Coolify
        env:
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
        run: |
          echo "üì¶ Deploying web app (e2e.chrry.ai)..."
          curl -X GET "https://coolify.askvex.com/api/v1/deploy?uuid=xcgo4kw884kkow40wk040sco&force=false" \
            -H "Authorization: Bearer $COOLIFY_TOKEN"

      - name: Wait for Web deployment
        run: |
          echo "‚è≥ Waiting for Web to finish deploying..."
          MAX_ATTEMPTS=150
          ATTEMPT=0

          # Read expected version from package.json
          EXPECTED_VERSION=$(jq -r '.version' package.json)

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            echo "üîç Checking $STAGING_URL/api/health..."
            if curl -f --compressed $STAGING_URL/api/health > /dev/null 2>&1; then
              WEB_VERSION=$(curl -s --compressed $STAGING_URL/api/health | jq -r '.version' 2>/dev/null || echo "unknown")
              echo "üì¶ Web version: $WEB_VERSION (expected: $EXPECTED_VERSION)"

              if [ "$WEB_VERSION" = "$EXPECTED_VERSION" ]; then
                echo "‚úÖ Web deployment complete!"
                exit 0
              fi
            else
              echo "‚ùå Health check failed (curl exit code: $?)"
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "‚è≥ Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            sleep 10
          done

          echo "‚ùå Web deployment timed out"
          exit 1

  # Run Guest E2E tests first (uses shared fingerprints)

  e2e-guest-live:
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        run: pnpm --filter @chrryai/waffles exec playwright install --with-deps

      - name: Run Live Guest Playwright tests (Real AI)
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.STAGING_URL }}
          VEX_LIVE_FINGERPRINTS: ${{ secrets.VEX_LIVE_FINGERPRINTS }}
        run: pnpm --filter @chrryai/waffles exec playwright test guest.live.spec.ts

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-guest-live
          path: packages/waffles/playwright-report/
          retention-days: 30

      - name: Upload Test Results to Trunk
        if: ${{ !cancelled() }}
        continue-on-error: true
        uses: trunk-io/analytics-uploader@main
        with:
          junit-paths: packages/waffles/junit.xml
          org-slug: chrry
          token: ${{ secrets.TRUNK_API_TOKEN }}

  # Run Member E2E tests (Grape/Pear flows, spatial nav)
  e2e-member-live:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    needs: e2e-guest-live
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        run: pnpm --filter @chrryai/waffles exec playwright install --with-deps

      - name: Run Live Member Playwright tests (Real AI)
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.STAGING_URL }}
          VEX_LIVE_FINGERPRINTS: ${{ secrets.VEX_LIVE_FINGERPRINTS }}
        run: pnpm --filter @chrryai/waffles exec playwright test member.live.spec.ts

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-member-live
          path: packages/waffles/playwright-report/
          retention-days: 30

      - name: Upload Test Results to Trunk
        if: ${{ !cancelled() }}
        continue-on-error: true
        uses: trunk-io/analytics-uploader@293e9b144a101ef4b8fe3485a5afd0224fc48255
        with:
          junit-paths: packages/waffles/junit.xml
          org-slug: chrry
          token: ${{ secrets.TRUNK_API_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge to dev
        # G√úVENLƒ∞ KATMAN: Veriyi env olarak haritalƒ±yoruz
        env:
          HEAD_REF: ${{ github.head_ref || github.ref_name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "üîÄ Auto-merging $HEAD_REF to dev branch..."
          git fetch origin dev
          git checkout dev

          if [ -n "$PR_NUMBER" ]; then
            MSG="Auto-merge PR #$PR_NUMBER: $PR_TITLE"
          else
            MSG="Auto-merge branch $HEAD_REF to dev"
          fi

          # Deƒüi≈ükenleri shell variable olarak ($) kullanƒ±yoruz
          git merge --no-ff "origin/$HEAD_REF" -m "$MSG"
          git push origin dev
          echo "‚úÖ Successfully merged to dev!"
  #Auto-merge to web branch after all tests pass
  auto-merge-to-web:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    needs: [e2e-member-live]
    if: success()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge to web
        env:
          HEAD_REF: ${{ github.head_ref || github.ref_name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "üîÄ Auto-merging $HEAD_REF to web branch..."
          git fetch origin web
          git checkout web

          if [ -n "$PR_NUMBER" ]; then
            MSG="Auto-merge PR #$PR_NUMBER: $PR_TITLE"
          else
            MSG="Auto-merge branch $HEAD_REF to web"
          fi

          git merge --no-ff "origin/$HEAD_REF" -m "$MSG"
          git push origin web
          echo "‚úÖ Successfully merged to web!"
