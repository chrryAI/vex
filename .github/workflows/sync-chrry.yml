name: Sync Chrry to Separate Repo

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - main # Sync to chrry repo when merged to main
    paths:
      - 'packages/ui/**' # Only trigger if ui package changed

jobs:
  sync-chrry:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Vex repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history to merge with main
          token: ${{ secrets.CHRRY_SYNC_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.1.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # - name: Cache Turbo
      #   uses: actions/cache@v4
      #   with:
      #     path: .turbo
      #     key: ${{ runner.os }}-turbo-${{ github.sha }}
      #     restore-keys: |
      #       ${{ runner.os }}-turbo-

      # - name: Build with Turbo
      #   run: |
      #     npx turbo build
      #   env:
      #     NODE_OPTIONS: --max-old-space-size=4096

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      #   - name: Sync chrry branch with main
      #     run: |
      #       # Fetch latest main
      #       git fetch origin main

      #       # Merge main into chrry (keep chrry checked out)
      #       git merge origin/main --no-edit || echo "Already up to date"

      - name: Create fresh Chrry commit
        run: |
          # Create temporary directory for Chrry
          mkdir -p /tmp/chrry-fresh

          # Copy only packages/ui contents
          cp -r packages/ui/* /tmp/chrry-fresh/
          cp -r packages/ui/.* /tmp/chrry-fresh/ 2>/dev/null || true

          # Initialize fresh repo
          cd /tmp/chrry-fresh
          git init

          # Configure Git for this repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          # Create single clean commit with current state
          COMMIT_MSG="Update Chrry UI Library üçí

          Synced from Vex monorepo
          Latest changes from packages/ui"

          git commit -m "$COMMIT_MSG"

      - name: Push to Chrry repo
        run: |
          cd /tmp/chrry-fresh

          # Add Chrry remote
          git remote add origin https://x-access-token:${{ secrets.CHRRY_SYNC_TOKEN }}@github.com/chrryAI/chrry.git

          # Create main branch and force push (clean history)
          git branch -M main
          git push -f origin main

      # - name: Merge chrry to main branch
      #   run: |
      #     # Configure Git
      #     git config user.name "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"

      #     # Checkout main and merge chrry
      #     git fetch origin main
      #     git checkout main
      #     git merge origin/chrry --no-edit

      #     # Push to main
      #     git push origin main
