name: Playwright Tests
on:
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  e2e:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    env:
      TESTING_ENV: e2e
      NEXT_PUBLIC_TESTING_ENV: e2e
      NEXT_PUBLIC_CI: true
      CI: true
      STAGING_URL: https://e2e.chrry.ai
      STAGING_API_URL: https://e2e.chrry.dev
      BUILD_ID: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Trigger Coolify deployments
        run: |
          echo "üöÄ Triggering sequential deployments for cache efficiency..."

          # Deploy web app first (builds fresh)
          echo "üì¶ Deploying web app (e2e.chrry.ai)..."
          curl -X GET "https://coolify.askvex.com/api/v1/deploy?uuid=xcgo4kw884kkow40wk040sco&force=false" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_TOKEN }}"

          # Wait for web deployment to complete
          echo "‚è≥ Waiting for web deployment to complete..."
          MAX_WAIT=600  # 10 minutes
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            if curl -f ${{ env.STAGING_URL }}/api/health > /dev/null 2>&1; then
              echo "‚úÖ Web app is deployed and healthy!"
              break
            fi
            sleep 10
            ELAPSED=$((ELAPSED + 10))
            echo "‚è≥ Still waiting... ($ELAPSED/$MAX_WAIT seconds)"
          done

          # Deploy API app (will use web's Turbo cache)
          echo "üì¶ Deploying API app (e2e.chrry.dev) - using cached build..."
          curl -X GET "https://coolify.askvex.com/api/v1/deploy?uuid=z84cko4g4kwss0gockcgkogw&force=false" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_TOKEN }}"

          # Wait for API deployment to complete
          echo "‚è≥ Waiting for API deployment to complete..."
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            if curl -f ${{ env.STAGING_API_URL }}/api/health > /dev/null 2>&1; then
              echo "‚úÖ API app is deployed and healthy!"
              break
            fi
            sleep 10
            ELAPSED=$((ELAPSED + 10))
            echo "‚è≥ Still waiting... ($ELAPSED/$MAX_WAIT seconds)"
          done

          # Deploy WebSocket server (will use cached build)
          echo "üì¶ Deploying WebSocket server (e2e-ws.chrry.dev) - using cached build..."
          curl -X GET "https://coolify.askvex.com/api/v1/deploy?uuid=y8kkk00co844wg880cw4w8k0&force=false" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_TOKEN }}"

          echo "‚úÖ All deployments triggered sequentially!"

      - name: Wait for staging deployment
        run: |
          echo "üöÄ Waiting for staging deployment..."
          echo "Expected build ID: ${{ github.sha }}"

          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            WEB_READY=false
            API_READY=false
            WS_READY=false
            
            # Check web server
            if curl -f ${{ env.STAGING_URL }}/api/health > /dev/null 2>&1; then
              WEB_BUILD_ID=$(curl -s ${{ env.STAGING_URL }}/api/health | jq -r '.version // "unknown"')
              EXPECTED_VERSION=$(jq -r '.version' package.json)
              echo "üì¶ Web version: $WEB_BUILD_ID (expected: $EXPECTED_VERSION)"
              
              # Check if it matches
              if [ "$WEB_BUILD_ID" = "$EXPECTED_VERSION" ] || [ "$WEB_BUILD_ID" = "unknown" ]; then
                WEB_READY=true
                echo "‚úÖ Web server is ready"
              else
                echo "‚è≥ Web server is up but version doesn't match yet"
              fi
            else
              echo "‚è≥ Waiting for web server..."
            fi
            
            # Check API server
            if curl -f ${{ env.STAGING_API_URL }}/api/health > /dev/null 2>&1; then
              API_BUILD_ID=$(curl -s ${{ env.STAGING_API_URL }}/api/health | jq -r '.version // "unknown"')
              EXPECTED_VERSION=$(jq -r '.version' package.json)
              echo "üì¶ API version: $API_BUILD_ID (expected: $EXPECTED_VERSION)"
              
              if [ "$API_BUILD_ID" = "$EXPECTED_VERSION" ] || [ "$API_BUILD_ID" = "unknown" ]; then
                API_READY=true
                echo "‚úÖ API server is ready"
              else
                echo "‚è≥ API server is up but version doesn't match yet"
              fi
            else
              echo "‚è≥ Waiting for API server..."
            fi
            
            # Check WebSocket server
            if curl -f https://e2e-ws.chrry.dev/health > /dev/null 2>&1; then
              WS_READY=true
              echo "‚úÖ WebSocket server is ready"
            else
              echo "‚è≥ Waiting for WebSocket server..."
            fi
            
            # All services ready?
            if [ "$WEB_READY" = true ] && [ "$API_READY" = true ] && [ "$WS_READY" = true ]; then
              echo "üéâ All services are deployed and ready!"
              break
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "‚è≥ Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            sleep 10
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "‚ùå Deployment timeout after 10 minutes"
            exit 1
          fi

      # - name: Seed E2E database (if needed)
      #   run: |
      #     echo "üå± Checking if E2E database needs seeding..."
      #     bash scripts/seed-e2e.sh
      #   env:
      #     DB_URL: ${{ secrets.E2E_DB_URL }}

      - name: Install Playwright Browsers
        run: pnpm --filter @chrryai/waffles exec playwright install --with-deps

      - name: Run Playwright tests
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.STAGING_URL }}
          VEX_TEST_EMAIL: ${{ secrets.VEX_TEST_EMAIL }}
          VEX_TEST_NAME: ${{ secrets.VEX_TEST_NAME }}
          VEX_TEST_PASSWORD: ${{ secrets.VEX_TEST_PASSWORD }}
          VEX_TEST_EMAIL_2: ${{ secrets.VEX_TEST_EMAIL_2 }}
          VEX_TEST_NAME_2: ${{ secrets.VEX_TEST_NAME_2 }}
          VEX_TEST_PASSWORD_2: ${{ secrets.VEX_TEST_PASSWORD_2 }}
          VEX_TEST_EMAIL_3: ${{ secrets.VEX_TEST_EMAIL_3 }}
          VEX_TEST_NAME_3: ${{ secrets.VEX_TEST_NAME_3 }}
          VEX_TEST_PASSWORD_3: ${{ secrets.VEX_TEST_PASSWORD_3 }}
          VEX_TEST_EMAIL_4: ${{ secrets.VEX_TEST_EMAIL_4 }}
          VEX_TEST_NAME_4: ${{ secrets.VEX_TEST_NAME_4 }}
          VEX_TEST_PASSWORD_4: ${{ secrets.VEX_TEST_PASSWORD_4 }}
          TEST_MEMBER_FINGERPRINTS: ${{ secrets.TEST_MEMBER_FINGERPRINTS }}
          TEST_MEMBER_EMAILS: ${{ secrets.TEST_MEMBER_EMAILS }}
          TEST_GUEST_FINGERPRINTS: ${{ secrets.TEST_GUEST_FINGERPRINTS }}
        run: pnpm --filter @chrryai/waffles e2e

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: packages/waffles/playwright-report/
          retention-days: 30
