# name: Publish Browser Extensions

# on:
#   push:
#     tags:
#       - "extension-v*"
#   workflow_dispatch:
#     inputs:
#       version:
#         description: "Extension version to publish"
#         required: true
#         default: "1.1.15"

# permissions:
#   contents: write # Required for creating releases

# jobs:
#   build-and-publish:
#     runs-on: ubuntu-latest
#     strategy:
#       matrix:
#         site: [atlas, focus, vex]
#         include:
#           - site: atlas
#             chrome_extension_id_secret: CHROME_EXTENSION_ID_ATLAS
#             firefox_addon_id_secret: FIREFOX_ADDON_ID_ATLAS
#           - site: focus
#             chrome_extension_id_secret: CHROME_EXTENSION_ID_FOCUS
#             firefox_addon_id_secret: FIREFOX_ADDON_ID_FOCUS
#           - site: vex
#             chrome_extension_id_secret: CHROME_EXTENSION_ID_VEX
#             firefox_addon_id_secret: FIREFOX_ADDON_ID_VEX

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: "20.19"
#           cache: "npm"

#       - name: Install dependencies
#         run: npm ci

#       - name: Build Chrome extension for ${{ matrix.site }}
#         run: |
#           cd apps/extension
#           MODE=${{ matrix.site }} npm run build:chrome
#         env:
#           MODE: ${{ matrix.site }}

#       - name: Verify build artifacts exist
#         run: |
#           set -e
#           echo "::group::List artifacts"
#           ls -lah apps/extension | sed 's/^/apps\/extension: /'
#           echo "::endgroup::"
#           test -f apps/extension/dist-chrome.zip || (echo "Missing apps/extension/dist-chrome.zip" && exit 1)

#       - name: Check Chrome Web Store secrets for ${{ matrix.site }}
#         id: check-chrome-secrets
#         run: |
#           # Select extension id secret for each site explicitly
#           if [[ "${{ matrix.site }}" == "SITE_A" ]]; then
#             EXTENSION_ID="${{ secrets.CHROME_EXTENSION_ID_SITE_A }}"
#           elif [[ "${{ matrix.site }}" == "SITE_B" ]]; then
#             EXTENSION_ID="${{ secrets.CHROME_EXTENSION_ID_SITE_B }}"
#           # Add more sites as required
#           else
#             EXTENSION_ID=""
#           fi
#           if [[ -z "${{ secrets.CHROME_CLIENT_ID }}" || -z "${{ secrets.CHROME_CLIENT_SECRET }}" || -z "${{ secrets.CHROME_REFRESH_TOKEN }}" || -z "$EXTENSION_ID" ]]; then
#             echo "chrome_secrets_available=false" >> $GITHUB_OUTPUT
#             echo "‚ùå Chrome Web Store secrets not configured for ${{ matrix.site }}. Skipping Chrome upload."
#             echo "Required secrets: CHROME_CLIENT_ID, CHROME_CLIENT_SECRET, CHROME_REFRESH_TOKEN, CHROME_EXTENSION_ID_${{ matrix.site }}"
#           else
#             echo "chrome_secrets_available=true" >> $GITHUB_OUTPUT
#             echo "‚úÖ Chrome Web Store secrets found for ${{ matrix.site }}"
#           fi

#       - name: Debug Chrome Extension Files
#         if: steps.check-chrome-secrets.outputs.chrome_secrets_available == 'true'
#         run: |
#           echo "::group::Chrome Extension Debug Info"
#           echo "Inspecting contents of dist-chrome.zip..."
#           ls -la apps/extension/dist-chrome.zip
#           mkdir -p temp_unzip
#           unzip -o apps/extension/dist-chrome.zip -d temp_unzip
#           echo "--- Contents of manifest.json ---"
#           cat temp_unzip/manifest.json
#           echo "---------------------------------"
#           echo "::endgroup::"

#       - name: Create Chrome Extension Keys JSON for ${{ matrix.site }}
#         id: create-chrome-json
#         if: steps.check-chrome-secrets.outputs.chrome_secrets_available == 'true'
#         run: |
#           JSON_CONTENT=$(jq -n \
#             --arg clientId "${{ secrets.CHROME_CLIENT_ID }}" \
#             --arg clientSecret "${{ secrets.CHROME_CLIENT_SECRET }}" \
#             --arg refreshToken "${{ secrets.CHROME_REFRESH_TOKEN }}" \
#             --arg extId "$(if [[ "${{ matrix.site }}" == "SITE_A" ]]; then echo "${{ secrets.CHROME_EXTENSION_ID_SITE_A }}"; elif [[ "${{ matrix.site }}" == "SITE_B" ]]; then echo "${{ secrets.CHROME_EXTENSION_ID_SITE_B }}"; else echo ""; fi)" \
#             '{\n              "$schema": "https://github.com/PlasmoHQ/bpp/raw/main/keys.schema.json",\n              "chrome": {\n                "zip": "dist-chrome.zip",\n                "clientId": $clientId,\n                "clientSecret": $clientSecret,\n                "refreshToken": $refreshToken,\n                "extId": $extId\n              }\n            }')
#           echo "CHROME_KEYS_JSON<<EOF" >> $GITHUB_ENV
#           echo "$JSON_CONTENT" >> $GITHUB_ENV
#           echo "EOF" >> $GITHUB_ENV

#           echo "::group::Debug Chrome Keys JSON for ${{ matrix.site }}"
#           echo "Generated chrome-keys.json content:"
#           echo "$JSON_CONTENT"
#           echo "::endgroup::"

#       - name: Upload ${{ matrix.site }} Chrome Extension to Web Store
#         if: steps.check-chrome-secrets.outputs.chrome_secrets_available == 'true'
#         uses: PlasmoHQ/bpp@v3
#         with:
#           keys: ${{ env.CHROME_KEYS_JSON }}
#           chrome-file: apps/extension/dist-chrome.zip
#           verbose: true

#       - name: Create GitHub Release
#         uses: softprops/action-gh-release@v2
#         if: startsWith(github.ref, 'refs/tags/')
#         with:
#           files: |
#             apps/extension/dist-chrome.zip
#           generate_release_notes: true
#           token: ${{ secrets.GITHUB_TOKEN }}
#           fail_on_unmatched_files: false

#       - name: Publishing Summary for ${{ matrix.site }}
#         if: always()
#         run: |
#           echo "## üì¶ ${{ matrix.site }} Extension Publishing Summary"
#           echo ""
#           if [[ "${{ steps.check-chrome-secrets.outputs.chrome_secrets_available }}" == "true" ]]; then
#             echo "‚úÖ Chrome Web Store: Published (${{ matrix.site }})"
#           else
#             echo "‚è≠Ô∏è  Chrome Web Store: Skipped (missing secrets)"
#             echo "   ‚ÑπÔ∏è  Configure these secrets to enable Chrome publishing:"
#             echo "      - CHROME_CLIENT_ID"
#             echo "      - CHROME_CLIENT_SECRET"
#             echo "      - CHROME_REFRESH_TOKEN"
#             echo "      - ${{ matrix.chrome_extension_id_secret }}"
#           fi
#           echo ""
#           echo "‚úÖ GitHub Release: Created with extension files"
