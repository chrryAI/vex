#!/bin/bash
set -e

echo "üîÑ Updating ClamAV virus definitions..."
freshclam

echo "üöÄ Starting ClamAV daemon..."
# Start clamd and capture output to a temp file
clamd > /tmp/clamd.log 2>&1 &
CLAMD_PID=$!
echo "ClamAV daemon started with PID: $CLAMD_PID"

echo "‚è≥ Waiting for ClamAV daemon to be ready (PID: $CLAMD_PID)..."
# Wait for clamd to start listening on port 3310
for i in {1..30}; do
  if nc -z localhost 3310 2>/dev/null; then
    echo "‚úÖ ClamAV daemon is ready!"
    break
  fi
  
  # Check if clamd process is still running
  if ! kill -0 $CLAMD_PID 2>/dev/null; then
    echo "‚ùå ClamAV daemon died! Checking logs..."
    echo "=== /tmp/clamd.log ==="
    cat /tmp/clamd.log 2>/dev/null || echo "No temp log found"
    echo "=== /var/log/clamav/clamd.log ==="
    cat /var/log/clamav/clamd.log 2>/dev/null || echo "No system log found"
    exit 1
  fi
  
  echo "Waiting for ClamAV... ($i/30)"
  sleep 1
done

# Final check
if ! nc -z localhost 3310 2>/dev/null; then
  echo "‚ùå ClamAV daemon failed to start after 30 seconds"
  echo "Checking clamd process:"
  ps aux | grep clamd || true
  echo "Checking port 3310:"
  netstat -tlnp | grep 3310 || true
  exit 1
fi

echo "‚úÖ Starting malware scanner service..."
npm start
