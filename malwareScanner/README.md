# Secure Malware Scanner

Production-ready ClamAV malware scanning microservice with comprehensive security features.

## Security Features ✅

- ✅ **Rate Limiting**: 10 requests per 15 minutes per IP
- ✅ **File Size Limit**: 100MB maximum
- ✅ **MIME Type Validation**: Magic number verification (not just extension)
- ✅ **API Key Authentication**: SHA256 hashed keys
- ✅ **Security Headers**: Helmet.js protection
- ✅ **Input Sanitization**: Filename sanitization
- ✅ **Audit Logging**: Complete request logging
- ✅ **No Bypass on Errors**: Failed scans reject files
- ✅ **Graceful Shutdown**: Proper signal handling

## Setup

### 1. Install Dependencies

```bash
cd malwareScanner
npm install
```

### 2. Configure Environment

```bash
cp .env.example .env
```

Edit `.env`:

```bash
# Generate API key hash
echo -n "your-secret-api-key" | sha256sum

# Add to .env
API_KEY_HASH=your-generated-hash
```

### 3. Start ClamAV

```bash
# Docker
docker run -d -p 3310:3310 clamav/clamav

# Or system service
sudo systemctl start clamav-daemon
```

### 4. Run Server

```bash
# Development
npm run dev

# Production
npm run prod
```

## API Usage

### Health Check

```bash
curl http://localhost:3006/health
```

Response:

```json
{
  "status": "ok",
  "service": "malware-scanner",
  "version": "2.0.0",
  "clamav": "connected",
  "timestamp": "2026-02-10T..."
}
```

### Scan File

```bash
curl -X POST http://localhost:3006/scan \
  -H "x-api-key: your-api-key" \
  -F "file=@/path/to/file.pdf"
```

Response (safe):

```json
{
  "safe": true,
  "scanTime": 1234
}
```

Response (malware):

```json
{
  "safe": false,
  "threat": "Win.Test.EICAR_HDB-1",
  "scanTime": 567
}
```

## Security Best Practices

### API Key Management

1. Generate strong random API key:

   ```bash
   openssl rand -hex 32
   ```

2. Hash it:

   ```bash
   echo -n "your-key" | sha256sum
   ```

3. Store hash in `.env`, never commit actual key

### Production Deployment

- ✅ Use HTTPS (reverse proxy like nginx)
- ✅ Set `NODE_ENV=production`
- ✅ Configure proper logging
- ✅ Monitor ClamAV health
- ✅ Rotate API keys regularly
- ✅ Set up alerts for malware detections
- ✅ Keep ClamAV signatures updated

### Rate Limiting Tuning

Adjust based on your needs in `index.js`:

```javascript
const scanLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 10, // requests per window
})
```

## Allowed File Types

MIME type validation (not just extensions):

- Video: mov, mp4, webm, avi, mkv
- Image: png, jpg, gif
- Documents: pdf, txt, json
- Archives: zip

To add more types, update `ALLOWED_MIME_TYPES` in `index.js`.

## Logging

Structured JSON logs in production:

```json
{
  "timestamp": "2026-02-10T...",
  "level": "info",
  "message": "Scan request received",
  "requestId": "uuid",
  "ip": "1.2.3.4",
  "filename": "test.pdf",
  "size": 12345
}
```

## Error Handling

- **400**: Invalid request (no file, wrong type)
- **401**: Unauthorized (missing/invalid API key)
- **429**: Too many requests (rate limit)
- **500**: Server error (ClamAV failure)

## Monitoring

Health check endpoint for monitoring:

```bash
curl http://localhost:3006/health
```

## Development

Debug logging in development mode:

```bash
NODE_ENV=development node index.js
```

## Testing with EICAR

Test malware detection:

```bash
# Create EICAR test file
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.txt

# Scan it
curl -X POST http://localhost:3006/scan \
  -H "x-api-key: your-key" \
  -F "file=@eicar.txt"
```

Should return: `{ "safe": false, "threat": "..." }`

## Troubleshooting

### ClamAV Connection Failed

Check if ClamAV is running:

```bash
# Docker
docker ps | grep clamav

# System
sudo systemctl status clamav-daemon
```

### Rate Limit Too Strict

Adjust `scanLimiter` configuration or use different API keys for different services.

### MIME Type Rejected

Add the MIME type to `ALLOWED_MIME_TYPES` array if it's a legitimate file type.

## License

AGPL-3.0
