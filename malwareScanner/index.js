// Simple Express server for malware scanning
const express = require("express")
const NodeClam = require("clamscan")
const multer = require("multer")

const app = express()
const upload = multer({ storage: multer.memoryStorage() })

let clamav = null

// Initialize ClamAV
async function initClamAV() {
  if (clamav) return clamav

  try {
    clamav = await new NodeClam().init({
      clamdscan: {
        host: "localhost",
        port: 3310,
        timeout: 300000, // 5 minutes for large files
        multiscan: true,
        reloadDb: false,
        active: true,
        bypassTest: false,
      },
      preference: "clamdscan",
    })

    console.log("âœ… ClamAV initialized")
    return clamav
  } catch (error) {
    console.error("âŒ ClamAV init failed:", error)
    throw error
  }
}

// Middleware to check API key
function checkApiKey(req, res, next) {
  const apiKey = process.env.API_KEY

  // If API_KEY is set, validate it
  if (apiKey) {
    const providedKey = req.headers["x-api-key"]

    if (!providedKey || providedKey !== apiKey) {
      return res.status(401).json({ error: "Unauthorized" })
    }
  }

  next()
}

// Health check (no auth required)
app.get("/health", (req, res) => {
  res.json({ status: "ok", service: "malware-scanner" })
})

// Scan file endpoint (with API key check)
app.post("/scan", checkApiKey, upload.single("file"), async (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ error: "No file provided" })
    }

    const clam = await initClamAV()

    // Use scanStream with a readable stream from buffer
    const { Readable } = require("stream")
    const stream = Readable.from(req.file.buffer)

    const { isInfected, viruses } = await clam.scanStream(stream)

    if (isInfected && viruses && viruses.length > 0) {
      const threat = viruses[0]

      // Filter out false positives for safe media formats
      const FALSE_POSITIVE_PATTERNS = [
        /Heuristics\.Broken\./i, // Broken file format (not malware)
        /Heuristics\.Limits\./i, // File size/complexity limits
        /Heuristics\.Encrypted/i, // Encrypted containers
        /PUA\.Win\./i, // Potentially unwanted app (Windows only)
        /Oversized\./i, // File too large for full scan
        /Structured\./i, // Structured data warnings
      ]

      // Check if this is a known false positive
      const isFalsePositive = FALSE_POSITIVE_PATTERNS.some((pattern) =>
        pattern.test(threat),
      )

      // Get file extension
      const filename = req.file.originalname || ""
      const ext = filename.toLowerCase().split(".").pop()
      const SAFE_MEDIA_EXTENSIONS = [
        "mov",
        "mp4",
        "webm",
        "avi",
        "mkv",
        "png",
        "jpg",
        "jpeg",
        "gif",
        "pdf",
      ]
      const isSafeMedia = SAFE_MEDIA_EXTENSIONS.includes(ext)

      // If it's a false positive on safe media, allow it
      if (isFalsePositive && isSafeMedia) {
        console.log(`âš ï¸ Ignoring false positive "${threat}" for .${ext} file`)
        return res.json({ safe: true })
      }

      // Real malware detected
      console.warn("ğŸš¨ Malware detected:", threat)
      return res.json({
        safe: false,
        threat: threat,
      })
    }

    console.log("âœ… File passed scan")
    res.json({ safe: true })
  } catch (error) {
    console.error("âŒ Scan error:", error)

    // Handle EPIPE errors (ClamAV connection closed)
    if (error.code === "EPIPE" || error.errno === -32) {
      // Get file extension
      const filename = req.file?.originalname || ""
      const ext = filename.toLowerCase().split(".").pop()
      const SAFE_MEDIA_EXTENSIONS = [
        "mov",
        "mp4",
        "webm",
        "avi",
        "mkv",
        "png",
        "jpg",
        "jpeg",
        "gif",
        "pdf",
        "txt",
      ]
      const isSafeMedia = SAFE_MEDIA_EXTENSIONS.includes(ext)

      if (isSafeMedia) {
        console.log(
          `âš ï¸ ClamAV EPIPE error on .${ext} file - allowing safe media type`,
        )
        return res.json({ safe: true })
      }
    }

    res.status(500).json({ error: "Scan failed" })
  }
})

const PORT = process.env.PORT || 3006

app.listen(PORT, () => {
  console.log(`ğŸ” Malware scanner running on port ${PORT}`)
  initClamAV().catch(console.error)
})
