FROM node:20-slim

# Install ClamAV and netcat for health checks
RUN apt-get update && \
    apt-get install -y clamav clamav-daemon clamav-freshclam netcat-openbsd && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create ClamAV directories with proper permissions
RUN mkdir -p /var/run/clamav && \
    chown -R clamav:clamav /var/run/clamav && \
    chmod 755 /var/run/clamav

WORKDIR /app

# Install pnpm
RUN npm install -g pnpm

# Copy package files
COPY package*.json ./
COPY pnpm-lock.yaml* ./

# Install dependencies (skip prepare scripts like husky)
RUN pnpm install --prod --frozen-lockfile --ignore-scripts

# Copy app and config
COPY . .

# Copy ClamAV config
RUN cp clamd.conf /etc/clamav/clamd.conf && \
    mkdir -p /var/log/clamav && \
    chown -R clamav:clamav /var/log/clamav && \
    chmod 755 /var/log/clamav

# Make start script executable
RUN chmod +x start.sh

# Expose port
EXPOSE 3006

# Start script
CMD ["./start.sh"]
