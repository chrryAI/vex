FROM node:20-slim

# Install ClamAV and netcat for health checks
RUN apt-get update && \
    apt-get install -y clamav clamav-daemon clamav-freshclam netcat-openbsd && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create ClamAV directories with proper permissions
RUN mkdir -p /var/run/clamav /var/log/clamav /var/lib/clamav && \
    chown -R clamav:clamav /var/run/clamav /var/lib/clamav && \
    chmod 755 /var/run/clamav && \
    chmod 775 /var/lib/clamav && \
    chmod 775 /var/log/clamav && \
    chown clamav:clamav /var/log/clamav && \
    touch /var/log/clamav/freshclam.log && \
    chown clamav:clamav /var/log/clamav/freshclam.log && \
    chmod 664 /var/log/clamav/freshclam.log

# Create app user and group
RUN groupadd -r scanner && useradd -r -g scanner scanner

WORKDIR /app

# Copy package files
COPY --chown=scanner:scanner package*.json ./

# Install dependencies
RUN npm install --production --ignore-scripts

# Copy app and config
COPY --chown=scanner:scanner . .

# Copy ClamAV config and set permissions
RUN cp clamd.conf /etc/clamav/clamd.conf && \
    chown clamav:clamav /etc/clamav/clamd.conf && \
    chmod 644 /etc/clamav/clamd.conf

# Make start script executable
RUN chmod +x start.sh && \
    chown scanner:scanner start.sh

# Give scanner user access to ClamAV socket
RUN usermod -a -G clamav scanner

# Expose port
EXPOSE 3006

# Switch to non-root user
USER scanner

# Start script
CMD ["./start.sh"]
